// Sistema de Rpg
// Sistema unico, diferente de qualquer outro bot
// Criador: Hiudy
// Caso for usar deixe o caralho dos cr√©ditos 
// <3

const players = {};

const classes = {
    guerreiro: {
        name: 'Guerreiro',
        baseHp: 120,
        baseAttack: 15,
        baseDefense: 10,
        skills: {
            'Golpe Forte': {
                damage: 20,
                cost: 10,
                description: 'Um golpe poderoso que causa dano extra'
            },
            'Defesa Total': {
                effect: 'defense_up',
                value: 15,
                cost: 15,
                description: 'Aumenta sua defesa temporariamente'
            }
        }
    },
    mago: {
        name: 'Mago',
        baseHp: 80,
        baseAttack: 20,
        baseDefense: 5,
        skills: {
            'Bola de Fogo': {
                damage: 30,
                cost: 15,
                description: 'Uma poderosa bola de fogo'
            },
            'Escudo M√°gico': {
                effect: 'defense_up',
                value: 20,
                cost: 20,
                description: 'Cria um escudo m√°gico protetor'
            }
        }
    },
    arqueiro: {
        name: 'Arqueiro',
        baseHp: 90,
        baseAttack: 18,
        baseDefense: 7,
        skills: {
            'Flecha Precisa': {
                damage: 25,
                cost: 12,
                description: 'Uma flecha com precis√£o mortal'
            },
            'Chuva de Flechas': {
                damage: 35,
                cost: 25,
                description: 'Dispara m√∫ltiplas flechas'
            }
        }
    }
};

const dungeons = {
    floresta: {
        name: 'Floresta Sombria',
        minLevel: 1,
        maxLevel: 5,
        monsters: [
            { name: 'üê∫ Lobo Selvagem', hp: 50, attack: 8, defense: 3, xp: 20, gold: 15 },
            { name: 'üï∑Ô∏è Aranha Gigante', hp: 40, attack: 12, defense: 2, xp: 25, gold: 20 },
            { name: 'üå≥ Ent Furioso', hp: 80, attack: 10, defense: 8, xp: 35, gold: 30 }
        ],
        boss: { name: 'üêó Javali Ancestral', hp: 150, attack: 20, defense: 12, xp: 100, gold: 100 }
    },
    caverna: {
        name: 'Caverna das Sombras',
        minLevel: 5,
        maxLevel: 10,
        monsters: [
            { name: 'üíÄ Esqueleto', hp: 70, attack: 15, defense: 5, xp: 40, gold: 35 },
            { name: 'üßü Zumbi', hp: 100, attack: 12, defense: 8, xp: 45, gold: 40 },
            { name: 'ü¶á Morcego Vampiro', hp: 60, attack: 18, defense: 4, xp: 50, gold: 45 }
        ],
        boss: { name: 'üßõ‚Äç‚ôÇÔ∏è Vampiro Anci√£o', hp: 200, attack: 25, defense: 15, xp: 150, gold: 150 }
    },
    vulcao: {
        name: 'Vulc√£o Ardente',
        minLevel: 10,
        maxLevel: 15,
        monsters: [
            { name: 'üî• Elemental de Fogo', hp: 120, attack: 22, defense: 10, xp: 70, gold: 60 },
            { name: 'ü¶é Lagarto de Lava', hp: 100, attack: 25, defense: 12, xp: 75, gold: 65 },
            { name: 'üåã Golem de Magma', hp: 150, attack: 20, defense: 18, xp: 80, gold: 70 }
        ],
        boss: { name: 'üê≤ Drag√£o de Fogo', hp: 300, attack: 35, defense: 25, xp: 200, gold: 200 }
    }
};

const shopItems = {
    'Po√ß√£o de Cura Pequena': {
        type: 'potion',
        effect: 'heal',
        value: 30,
        price: 50,
        description: 'Recupera 30 HP'
    },
    'Po√ß√£o de Cura M√©dia': {
        type: 'potion',
        effect: 'heal',
        value: 70,
        price: 100,
        description: 'Recupera 70 HP'
    },
    'Po√ß√£o de Cura Grande': {
        type: 'potion',
        effect: 'heal',
        value: 150,
        price: 200,
        description: 'Recupera 150 HP'
    },
    'Po√ß√£o de For√ßa': {
        type: 'potion',
        effect: 'attack_up',
        value: 10,
        duration: 3,
        price: 150,
        description: 'Aumenta o ataque em 10 por 3 turnos'
    },
    'Po√ß√£o de Defesa': {
        type: 'potion',
        effect: 'defense_up',
        value: 8,
        duration: 3,
        price: 150,
        description: 'Aumenta a defesa em 8 por 3 turnos'
    },
    'Espada de Ferro': {
        type: 'weapon',
        attack: 15,
        price: 300,
        class: 'guerreiro',
        description: 'Uma espada b√°sica mas confi√°vel'
    },
    'Cajado M√≠stico': {
        type: 'weapon',
        attack: 20,
        price: 300,
        class: 'mago',
        description: 'Um cajado que amplifica magias'
    },
    'Arco Longo': {
        type: 'weapon',
        attack: 18,
        price: 300,
        class: 'arqueiro',
        description: 'Um arco com excelente alcance'
    },
    'Armadura de Ferro': {
        type: 'armor',
        defense: 12,
        price: 300,
        class: 'guerreiro',
        description: 'Uma armadura resistente'
    },
    'Vestes M√≠sticas': {
        type: 'armor',
        defense: 8,
        price: 300,
        class: 'mago',
        description: 'Vestes que aumentam o poder m√°gico'
    },
    'Armadura de Couro': {
        type: 'armor',
        defense: 10,
        price: 300,
        class: 'arqueiro',
        description: 'Armadura leve e flex√≠vel'
    }
};

class RPGPlayer {
    constructor(id, className) {
        this.id = id;
        this.className = className;
        this.level = 1;
        this.xp = 0;
        this.gold = 100;

        const classData = classes[className];
        this.hp = classData.baseHp;
        this.maxHp = classData.baseHp;
        this.attack = classData.baseAttack;
        this.defense = classData.baseDefense;
        this.skills = {...classData.skills};

        this.inventory = [];
        this.equipment = {
            weapon: null,
            armor: null
        };

        this.inBattle = false;
        this.currentDungeon = null;
        this.buffs = [];
    };

    gainXP(amount) {
        this.xp += amount;
        if (this.xp >= this.level * 100) {
            this.levelUp();
            return true;
        }
        return false;
    }

    levelUp() {
        this.level++;
        this.xp = 0;

        const classData = classes[this.className];
        this.maxHp += Math.floor(classData.baseHp * 0.1);
        this.hp = this.maxHp;
        this.attack += Math.floor(classData.baseAttack * 0.1);
        this.defense += Math.floor(classData.baseDefense * 0.1);
    }

    heal(amount) {
        this.hp = Math.min(this.hp + amount, this.maxHp);
    }

    takeDamage(amount) {
        const totalDefense = this.defense + (this.equipment.armor ? this.equipment.armor.defense : 0);
        const damage = Math.max(1, amount - totalDefense);
        this.hp = Math.max(0, this.hp - damage);
        return damage;
    }

    getTotalAttack() {
        return this.attack + (this.equipment.weapon ? this.equipment.weapon.attack : 0);
    }

    getTotalDefense() {
        return this.defense + (this.equipment.armor ? this.equipment.armor.defense : 0);
    }

    addItem(item) {
        this.inventory.push(item);
    }

    useItem(itemName) {
        const itemIndex = this.inventory.findIndex(i => i === itemName);
        if (itemIndex === -1) return null;
        
        const item = shopItems[itemName];
        if (!item) return null;

        this.inventory.splice(itemIndex, 1);

        if (item.type === 'potion') {
            if (item.effect === 'heal') {
                this.heal(item.value);
                return `‚ù§Ô∏è Voc√™ recuperou ${item.value} HP!`;
            } else {
                this.buffs.push({
                    effect: item.effect,
                    value: item.value,
                    duration: item.duration
                });
                return `‚ö° ${item.description}`;
            }
        }
        return null;
    }

    equipItem(itemName) {
        const item = shopItems[itemName];
        if (!item) return { success: false, message: '‚ùå Item n√£o encontrado!' };
        if (item.class && item.class !== this.className) {
            return { success: false, message: '‚ùå Sua classe n√£o pode equipar este item!' };
        }

        const itemIndex = this.inventory.findIndex(i => i === itemName);
        if (itemIndex === -1) {
            return { success: false, message: '‚ùå Voc√™ n√£o possui este item!' };
        }

        this.inventory.splice(itemIndex, 1);

        if (item.type === 'weapon' || item.type === 'armor') {
            const currentItem = this.equipment[item.type];
            if (currentItem) {
                this.inventory.push(currentItem.name);
            }
            this.equipment[item.type] = {
                name: itemName,
                ...item
            };
        }

        return { 
            success: true, 
            message: `‚úÖ ${itemName} equipado com sucesso!` 
        };
    };

    getStatus() {
        return `üéÆ *Status do Jogador*\n\n` +
               `üìä Level: ${this.level}\n` +
               `‚≠ê XP: ${this.xp}/${this.level * 100}\n` +
               `‚ù§Ô∏è HP: ${this.hp}/${this.maxHp}\n` +
               `‚öîÔ∏è Ataque: ${this.getTotalAttack()} (${this.attack} + ${this.getTotalAttack() - this.attack})\n` +
               `üõ°Ô∏è Defesa: ${this.getTotalDefense()} (${this.defense} + ${this.getTotalDefense() - this.defense})\n` +
               `üí∞ Ouro: ${this.gold}\n\n` +
               `üéí Invent√°rio:\n${this.inventory.length ? this.inventory.join('\n') : 'Vazio'}\n\n` +
               `‚öîÔ∏è Arma: ${this.equipment.weapon ? this.equipment.weapon.name : 'Nenhuma'}\n` +
               `üõ°Ô∏è Armadura: ${this.equipment.armor ? this.equipment.armor.name : 'Nenhuma'}`;
    };
};

module.exports = {
    createPlayer: (userId, className) => {
        if (!classes[className]) {
            return { 
                success: false, 
                message: '‚ùå Classe inv√°lida! Escolha entre: ' + Object.keys(classes).join(', ')
            };
        };
        
        if (players[userId]) {
            return { 
                success: false, 
                message: '‚ùå Voc√™ j√° tem um personagem! Use /rpgstatus para ver seus status.'
            };
        }

        players[userId] = new RPGPlayer(userId, className);
        return {
            success: true,
            message: `‚úÖ Personagem criado com sucesso!\n\nClasse: ${classes[className].name}\n\n${players[userId].getStatus()}`
        };
    },

    getPlayer: (userId) => players[userId],

    getClasses: () => {
        let text = 'üéÆ *Classes Dispon√≠veis*\n\n';
        Object.entries(classes).forEach(([id, data]) => {
            text += `*${data.name}*\n`;
            text += `‚ù§Ô∏è HP: ${data.baseHp}\n`;
            text += `‚öîÔ∏è Ataque: ${data.baseAttack}\n`;
            text += `üõ°Ô∏è Defesa: ${data.baseDefense}\n`;
            text += `\n*Habilidades:*\n`;
            Object.entries(data.skills).forEach(([name, skill]) => {
                text += `‚û§ ${name}: ${skill.description}\n`;
            });
            text += '\n';
        });
        return text;
    },

    enterDungeon: (player, dungeonName) => {
        const dungeon = dungeons[dungeonName];
        if (!dungeon) {
            return { 
                success: false, 
                message: '‚ùå Dungeon n√£o encontrada! Dispon√≠veis: ' + Object.keys(dungeons).join(', ')
            };
        };

        if (player.level < dungeon.minLevel) {
            return {
                success: false,
                message: `‚ùå Voc√™ precisa ser n√≠vel ${dungeon.minLevel} para entrar em ${dungeon.name}!`
            };
        };

        const isBoss = Math.random() < 0.1;
        const monster = isBoss ? {...dungeon.boss} : {...dungeon.monsters[Math.floor(Math.random() * dungeon.monsters.length)]};

        player.inBattle = true;
        player.currentDungeon = {
            name: dungeonName,
            monster: monster,
            turns: 0
        };

        return {
            success: true,
            message: `‚öîÔ∏è *BATALHA INICIADA!*\n\n` +
                    `Voc√™ encontrou ${monster.name} em ${dungeon.name}!\n\n` +
                    `üëæ *Monstro:*\n` +
                    `‚ù§Ô∏è HP: ${monster.hp}\n` +
                    `‚öîÔ∏è Ataque: ${monster.attack}\n` +
                    `üõ°Ô∏è Defesa: ${monster.defense}\n\n` +
                    `Comandos dispon√≠veis:\n` +
                    `‚û§ /rpgattack - Ataque b√°sico\n` +
                    `‚û§ /rpgskill <nome> - Usa uma habilidade\n` +
                    `‚û§ /rpgitem <nome> - Usa um item\n` +
                    `‚û§ /rpgflee - Tenta fugir`
        };
    },

    processAttack: (player, isSkill = false, skillName = null) => {
        if (!player.inBattle || !player.currentDungeon) {
            return { success: false, message: '‚ùå Voc√™ n√£o est√° em batalha!' };
        };
        const monster = player.currentDungeon.monster;
        let damage = player.getTotalAttack();
        let log = '';
        if (isSkill && skillName) {
            const skill = player.skills[skillName];
            if (!skill) {
                return { success: false, message: '‚ùå Habilidade n√£o encontrada!' };
            }
            damage = skill.damage || damage;
            log += `üéØ Voc√™ usou ${skillName}!\n`;
        };
        const monsterDamage = Math.max(1, damage - monster.defense);
        monster.hp -= monsterDamage;
        log += `üëä Voc√™ causou ${monsterDamage} de dano!\n`;
        if (monster.hp <= 0) {
            player.inBattle = false;
            player.gold += monster.gold;
            const leveledUp = player.gainXP(monster.xp);
            log += `\nüéâ *Vit√≥ria!*\n`;
            log += `üí∞ +${monster.gold} ouro\n`;
            log += `‚≠ê +${monster.xp} XP\n`;
            if (leveledUp) {
                log += `\nüÜô *Level Up!* Voc√™ alcan√ßou o n√≠vel ${player.level}!\n`;
            };
            player.currentDungeon = null;
            return { success: true, log, battle: false };
        };
        const playerDamage = player.takeDamage(monster.attack);
        log += `üòà ${monster.name} causou ${playerDamage} de dano!\n\n`;
        log += `Status:\n`;
        log += `‚ù§Ô∏è Seu HP: ${player.hp}/${player.maxHp}\n`;
        log += `‚ù§Ô∏è HP do ${monster.name}: ${monster.hp}\n`;
        if (player.hp <= 0) {
            player.inBattle = false;
            player.hp = Math.max(1, player.maxHp / 2);
            player.gold = Math.max(0, player.gold - Math.floor(player.gold * 0.1));
            
            log += `\nüíÄ *Derrota!*\n`;
            log += `Voc√™ perdeu 10% do seu ouro!\n`;
            player.currentDungeon = null;
            return { success: true, log, battle: false };
        };
        return { success: true, log, battle: true };
    },

    flee: (player) => {
        if (!player.inBattle || !player.currentDungeon) {
            return { success: false, message: '‚ùå Voc√™ n√£o est√° em batalha!' };
        };
        const escapeChance = 0.5;
        if (Math.random() < escapeChance) {
            player.inBattle = false;
            player.currentDungeon = null;
            return { 
                success: true, 
                message: 'üèÉ‚Äç‚ôÇÔ∏è Voc√™ conseguiu fugir com sucesso!' 
            };
        };
        const monster = player.currentDungeon.monster;
        const damage = player.takeDamage(monster.attack);
        return {
            success: false,
            message: `‚ùå Voc√™ falhou em fugir!\nüòà ${monster.name} causou ${damage} de dano!\n\n‚ù§Ô∏è Seu HP: ${player.hp}/${player.maxHp}`
        };
    },

    shop: {
        items: shopItems,
        buyItem: (player, itemName) => {
            const item = shopItems[itemName];
            if (!item) {
                return { success: false, message: '‚ùå Item n√£o encontrado!' };
            };
            if (player.gold < item.price) {
                return { success: false, message: '‚ùå Ouro insuficiente!' };
            };
            player.gold -= item.price;
            player.addItem(itemName);
            return { 
                success: true, 
                message: `‚úÖ Item comprado com sucesso!\nüí∞ Ouro restante: ${player.gold}`
            };
        },
        
        listItems: () => {
            let text = 'üè™ *LOJA DO RPG*\n\n';
            text += 'üß™ *Po√ß√µes:*\n';
            Object.entries(shopItems)
                .filter(([,item]) => item.type === 'potion')
                .forEach(([name, item]) => {
                    text += `‚û§ ${name} - üí∞ ${item.price}\n   ${item.description}\n`;
                });
            text += '\n‚öîÔ∏è *Armas:*\n';
            Object.entries(shopItems)
                .filter(([,item]) => item.type === 'weapon')
                .forEach(([name, item]) => {
                    text += `‚û§ ${name} - üí∞ ${item.price}\n   ATK: +${item.attack} | Classe: ${item.class}\n`;
                });
            text += '\nüõ°Ô∏è *Armaduras:*\n';
            Object.entries(shopItems)
                .filter(([,item]) => item.type === 'armor')
                .forEach(([name, item]) => {
                    text += `‚û§ ${name} - üí∞ ${item.price}\n   DEF: +${item.defense} | Classe: ${item.class}\n`;
                });
            
            return text;
        }
    },

    listDungeons: () => {
        let text = 'üó∫Ô∏è *DUNGEONS DISPON√çVEIS*\n\n';
        Object.entries(dungeons).forEach(([id, dungeon]) => {
            text += `*${dungeon.name}*\n`;
            text += `üìä N√≠vel: ${dungeon.minLevel}-${dungeon.maxLevel}\n\n`;
            text += `üëæ *Monstros:*\n`;
            dungeon.monsters.forEach(monster => {
                text += `‚û§ ${monster.name}\n`;
            });
            text += `\nüî• *Boss:* ${dungeon.boss.name}\n\n`;
        });
        return text;
    },

    getTopPlayers: () => {
        return Object.values(players)
            .sort((a, b) => b.level - a.level)
            .slice(0, 10)
            .map((p, i) => `${i + 1}. @${p.id.split('@')[0]} - ${classes[p.className].name} N√≠vel ${p.level}`);
    }
};
